<!--이 파일을 복사하여 templates/본인기능폴더 하위에 추가하여 작업해주세요-->
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content" class="container my-3">
    <link rel="stylesheet" href="/css/homework/homework_add.css">
    <div class="row">
        <!--<div th:replace="~{각페이지에맞는사이드바파일경로::sidebar}"></div>-->
        <div th:replace="~{/homework/baseSidebar::sidebar}" ></div>

        <div style="border: 1px solid black;" class="col-10"> <!--class에서 col-10은 빼면 안됨-->
            <!-- 맡은 기능 구현 하시면 됩니다! -->
            <div class="card">
            <h2>숙제 생성</h2>
                <form th:action="@{/homework/add}" th:object="${homeworksForm}" method="post">
                    <div>
                        <label>숙제 제목:</label>
                        <input type="text" th:field="*{homeworkTitle}">
                        <span th:if="${#fields.hasErrors('homeworkTitle')}" th:errors="*{homeworkTitle}">Invalid Title</span>
                    </div>
                    <div>
                        <label>숙제 내용:</label>
                        <textarea th:field="*{homeworkContent}"></textarea>
                        <span th:if="${#fields.hasErrors('homeworkContent')}" th:errors="*{homeworkContent}">Invalid Content</span>
                    </div>
                    <div>
                        <label>숙제 진도:</label>
                        <input type="number" th:field="*{progress}">레벨
                        <span th:if="${#fields.hasErrors('progress')}" th:errors="*{progress}">Invalid Progress</span>
                    </div>
                    <div>
                        <label>제출 기한:</label>
                        <input type="date" th:field="*{dueDate}">
                        <span th:if="${#fields.hasErrors('dueDate')}" th:errors="*{dueDate}">Invalid Date</span>
                    </div>
                    <div>
                        <label>숙제 메모:</label>
                        <textarea th:field="*{homeworkMemo}"></textarea>
                        <span th:if="${#fields.hasErrors('homeworkMemo')}" th:errors="*{homeworkMemo}">Invalid Memo</span>
                    </div>
                    <div>
                        <button type="submit">숙제 등록</button>
                    </div>
                </form>
            </div>

            <div class="baduk-board">
            <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="검색어를 입력하세요">
            <table id="homeworkTable">
                <tr>
                    <th onclick="sortTable(0)">No</th>
                    <th onclick="sortTable(1)">숙제 제목</th>
                    <th onclick="sortTable(2)">숙제 내용</th>
                    <th onclick="sortTable(3)">숙제 진도</th>
                    <th onclick="sortTable(4)">제출 기한</th>
                    <th onclick="sortTable(5)">전송 여부</th>
                    <th>수정</th>
                </tr>
                <tr th:each="hw, stat : ${homeworkList}" th:data-hw-id="${hw.homeworkNo}">
                    <td th:text="${homeworkList.size() - stat.count + 1}"></td>
                    <td th:text="${hw.homeworkTitle}"></td>
                    <td th:text="${hw.homeworkContentPreview}"></td>
                    <td th:text="${hw.progress}"></td>
                    <td th:text="${#dates.format(hw.dueDate, 'yyyy-MM-dd')}"></td>
                    <td th:text="${hw.isSent ? '전송 기록 있음' : '전송 기록 없음'}"></td>
                    <td><button class="edit-btn" th:data-hw-id="${hw.homeworkNo}" th:disabled="${hw.isSent}">수정</button></td>
                </tr>
                <!-- 목록이 없을 때의 메시지를 추가합니다. -->
                <tr th:if="${homeworkList == null or homeworkList.size() == 0}">
                    <td colspan="6">등록된 숙제가 없습니다.</td>
                </tr>
            </table>
                <div id="hw-pagination">
                    <button id="prevBtn">&laquo;</button>
                    <div id="pageNumbers"></div>
                    <button id="nextBtn">&raquo;</button>
                </div>
            </div>
            <!-- 숙제 상세 모달 -->
            <div id="hw-homeworkDetailModal">
                <h2 id="modalTitle"></h2>
                내용<p id="modalContent"></p>
                진도<p id="modalProgress"></p>
                메모<p id="modalMemo"></p>
                기한<p id="modalDueDate"></p>
                생성일<p id="modalCreateDate"></p>
            </div>
            <!-- 숙제 수정 모달 -->
            <div id="hw-editModal">
                <h2>숙제 수정</h2>
                <form id="editForm" th:action="@{/homework/edit}" th:object="${homeworksEditForm}" method="post">
                        <input type="hidden" th:field="*{hwNo}" th:id="'editNo'">
                    <div>
                        <label>숙제 제목:</label>
                        <input type="text" th:field="*{hwTitle}" th:id="'editTitle'"></input>
                        <span id="editTitleError" class="error-message"></span>
                    </div>
                    <div>
                        <label>숙제 내용:</label>
                        <textarea th:field="*{hwContent}" th:id="'editContent'"></textarea>
                        <span id="editContentError" class="error-message"></span>
                    </div>
                    <div>
                        <label>숙제 진도:</label>
                        <input type="number" th:field="*{hwProgress}" th:id="'editProgress'"></input>
                        <span id="editProgressError" class="error-message"></span>
                    </div>
                    <div>
                        <label>제출 기한:</label>
                        <input type="date" th:field="*{hwDueDate}" th:id="'editDueDate'"></input>
                        <span id="editDueDateError" class="error-message"></span>
                    </div>
                    <div>
                        <label>숙제 메모:</label>
                        <textarea th:field="*{hwMemo}" th:id="'editMemo'"></textarea>
                        <span id="editMemoError" class="error-message"></span>
                    </div>
                    <button type="submit">수정 제출</button>
                    <button type="button" id="deleteBtn">삭제</button>
                </form>
            </div>

            <div id="hw-backdrop"></div>
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>
                let sortOrder = true; // 기본값: true = 오름차순, false = 내림차순

                function getTotalRowCount() {
                    return $("#homeworkTable tr:not(.filtered-out)").length - 1; // excluding header
                }

                function getVisibleRowCount() {
                    return $("#homeworkTable tr:visible").length - 1; // excluding header
                }
                function updatePagination() {
                    totalRows = getTotalRowCount();
                    currentPage = 1; // reset to first page after search/sort
                    updateTableDisplay();
                }

            function searchTable() {
                var input, filter, table, tr, td, i, j, found;
                input = document.getElementById("searchInput");
                filter = input.value.toUpperCase();
                table = document.getElementById("homeworkTable");
                tr = table.getElementsByTagName("tr");
                let foundCount = 0;  // 검색 결과 카운터 추가

                // 검색 결과가 없는 경우 메시지 삭제
                $("#noSearchResult").remove();

                // 모든 행을 대상으로 검색
                for (i = 1; i < tr.length; i++) {
                    td = tr[i].getElementsByTagName("td");
                    found = false;
                    for (j = 0; j < td.length; j++) {  // 각 행의 모든 셀을 검색
                        if (td[j]) {
                            if (td[j].innerHTML.toUpperCase().indexOf(filter) > -1) {
                                found = true;  // 현재 행에서 일치하는 항목이 발견되면 플래그를 설정
                                break;
                            }
                        }
                    }
                    if (found) {
                        $(tr[i]).removeClass("filtered-out");
                        foundCount++;
                    } else {
                        $(tr[i]).addClass("filtered-out");
                    }
                }

                // 검색 결과가 없는 경우 메시지 표시
                if (foundCount == 0) {
                    $("#homeworkTable").hide(); // 테이블 전체를 숨김
                    $("#hw-pagination").hide(); // 페이지네이션 숨김
                    $("#homeworkTable").after('<p id="noSearchResult">검색 결과가 없습니다</p>'); // 테이블 바로 아래 메시지 추가
                } else {
                    $("#homeworkTable").show(); // 테이블 표시
                    $("#hw-pagination").show(); // 페이지네이션 표시
                }

                // 검색 후 첫 번째 페이지로 돌아감
                currentPage = 1;
                updatePagination();
            }

                function sortTable(columnIndex) {
                    var table, rows, switching, i, x, y, shouldSwitch;
                    table = document.getElementById("homeworkTable");
                    switching = true;
                    if (columnIndex === 0) { // 'No' 열일 경우 숫자로 비교
                    while (switching) {
                        switching = false;
                        rows = table.rows;
                        for (i = 1; i < (rows.length - 1); i++) {
                            shouldSwitch = false;
                            x = parseInt(rows[i].getElementsByTagName("TD")[columnIndex].innerText);
                            y = parseInt(rows[i + 1].getElementsByTagName("TD")[columnIndex].innerText);

                            if (sortOrder ? x > y : x < y) {
                                shouldSwitch = true;
                                break;
                            }
                        }
                        if (shouldSwitch) {
                            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                            switching = true;
                        }
                    }
                } else {
                        while (switching) {
                            switching = false;
                            rows = table.rows;
                            for (i = 1; i < (rows.length - 1); i++) {
                                shouldSwitch = false;
                                x = rows[i].getElementsByTagName("TD")[columnIndex];
                                y = rows[i + 1].getElementsByTagName("TD")[columnIndex];

                                if (sortOrder ? x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase() : x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                                    shouldSwitch = true;
                                    break;
                                }
                            }
                            if (shouldSwitch) {
                                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                                switching = true;
                            }
                        }
                    }
                    sortOrder = !sortOrder; // 정렬 순서를 토글합니다.
                    searchTable(); // 정렬 후 검색 함수를 다시 호출하여 검색된 결과를 유지합니다.
                }
                function formatDate(inputDate) {
                    const parts = inputDate.split("T")[0].split("-");
                    return parts[0] + "년 " + parts[1] + "월 " + parts[2] + "일";
                }
                $(document).ready(function(){
                    $("#homeworkTable tr").dblclick(function(){
                        var homeworkId = $(this).data('hw-id');

                        // API를 호출하여 숙제 상세 정보 및 전송 내역을 불러옵니다.
                        $.get("/homework/detail/" + homeworkId, function(data){
                            // 모달에 데이터 세팅
                            //$("#modalTitle").text(data.homeworkTitle);
                            $("#modalTitle").html(data.homeworkTitle.replace(/\n/g,'<br>'));
                            $("#modalContent").html(data.homeworkContent.replace(/\n/g, '<br>'));
                            $("#modalProgress").text(data.progress);
                            $("#modalMemo").html(data.homeworkMemo.replace(/\n/g,'<br>'))
                            $("#modalDueDate").text(formatDate(data.dueDate));
                            $("#modalCreateDate").text(formatDate(data.creationDate));

                            // 모달 및 오버레이 표시
                            $("#hw-homeworkDetailModal, #hw-backdrop").show();
                        });
                    });

                    // 모달 및 오버레이 외의 영역 클릭 시 모달 및 오버레이 숨김
                    $(document).on("click", function(e) {
                        if ($(e.target).closest("#hw-homeworkDetailModal").length === 0 &&
                            $(e.target).closest("#hw-editModal").length === 0 &&
                            $(e.target).closest("#homeworkTable").length === 0) {
                            $("#hw-homeworkDetailModal, #hw-backdrop, #hw-editModal").hide();
                        }
                    });

                });

                let currentPage = 1;
                const rowsPerPage = 15; // 한 페이지에 보일 행의 수를 15로 변경
                let totalRows = 0;

                function renderPagination() {
                    let totalPages = Math.ceil(totalRows / rowsPerPage);

                    // 현재 페이지를 중심으로 페이지네이션에 5개의 페이지 번호만 보이게 설정
                    let startPage = currentPage - 2;
                    let endPage = currentPage + 2;

                    // 시작 페이지와 마지막 페이지가 유효한 범위를 벗어나지 않도록 조정
                    if (startPage < 1) {
                        endPage -= (startPage - 1);
                        startPage = 1;
                    }
                    if (endPage > totalPages) {
                        startPage -= (endPage - totalPages);
                        endPage = totalPages;
                    }
                    startPage = Math.max(1, startPage);

                    let paginationHtml = '';
                    for (let i = startPage; i <= endPage; i++) {
                        paginationHtml += `<span class="hw-page-number ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</span>`;
                    }

                    $("#pageNumbers").html(paginationHtml);
                    $("#prevBtn").prop('disabled', currentPage === 1);
                    $("#nextBtn").prop('disabled', currentPage === totalPages);
                }

                function updateTableDisplay() {
                    let startRow = (currentPage - 1) * rowsPerPage + 1;
                    let endRow = startRow + rowsPerPage;

                    $("#homeworkTable tr").each(function(index, row) {
                        if (index === 0) { // Always show the header
                            $(row).show();
                        } else if ($(row).hasClass("filtered-out")) { // Always hide the rows filtered out by search
                            $(row).hide();
                        } else if (index >= startRow && index < endRow) {
                            $(row).show();
                        } else {
                            $(row).hide();
                        }
                    });

                    renderPagination();
                }


                $(document).ready(function() {
                    totalRows = $("#homeworkTable tr").length - 1; // 헤더 제외

                    $("#hw-pagination").on("click", ".hw-page-number", function() {
                        currentPage = $(this).data('page');
                        updateTableDisplay();
                    });

                    $("#prevBtn").click(function() {
                        if (currentPage > 1) {
                            currentPage--;
                            updateTableDisplay();
                        }
                    });

                    $("#nextBtn").click(function() {
                        if (currentPage < Math.ceil(totalRows / rowsPerPage)) {
                            currentPage++;
                            updateTableDisplay();
                        }
                    });

                    updateTableDisplay();
                });

                $(document).ready(function(){
                    // 수정 버튼 클릭 이벤트
                    $(".edit-btn").click(function(){
                        let homeworkId = $(this).data('hw-id');

                        // 해당 숙제의 데이터를 API에서 가져오거나
                        // 현재 페이지의 테이블에서 가져와서 모달의 폼에 채워 넣는 코드를 여기에 추가합니다.
                        // API를 호출하여 숙제 상세 정보 및 전송 내역을 불러옵니다.
                        $.get("/homework/detail/" + homeworkId, function(data){
                            // 모달에 데이터 세팅
                            $("#editNo").val(homeworkId);
                            $("#editTitle").val(data.homeworkTitle);
                            $("#editContent").text(data.homeworkContent);
                            $("#editProgress").val(data.progress);
                            $("#editMemo").val(data.homeworkMemo);
                            $("#editDueDate").val(data.dueDate.split("T")[0]);
                            console.log(data.dueDate);

                            // 모달 및 오버레이 표시
                            $("#hw-editModal, #hw-backdrop").show();
                        });
                    });

                    // 삭제 버튼 클릭 이벤트
                    $(document).ready(function(){
                        $(".edit-btn").click(function(){
                            let homeworkId = $(this).data('hw-id');

                            $.get("/homework/detail/" + homeworkId, function(data){
                                $("#editNo").val(homeworkId);
                                $("#editTitle").val(data.homeworkTitle);
                                $("#editContent").text(data.homeworkContent);
                                $("#editProgress").val(data.progress);
                                $("#editMemo").val(data.homeworkMemo);
                                $("#editDueDate").val(formatDate(data.dueDate.split("T")[0]));

                                // 여기서 data-hw-id 속성을 삭제 버튼에 설정합니다.
                                $("#deleteBtn").data('hw-id', homeworkId);

                                $("#hw-editModal, #hw-backdrop").show();
                            });
                        });

                        $("#deleteBtn").click(function(){
                            let homeworkId = $(this).data('hw-id');

                            if(homeworkId && confirm("숙제를 삭제하시겠습니까?")) {
                                $.ajax({
                                    url: `/homework/delete/${homeworkId}`,
                                    type: 'DELETE',
                                    success: function(response) {
                                        alert("숙제가 삭제되었습니다")
                                        location.reload();
                                    },
                                    error: function(xhr, status, error) {
                                        alert('삭제 실패: ' + xhr.responseText);
                                    }
                                });
                            } else {
                                alert('숙제 ID가 없습니다. 다시 시도해주세요.');
                            }
                        });
                    });

                });

                $("#editForm").submit(function(e) {
                    e.preventDefault();

                    $(".error-message").text("");  // 초기화

                    $.ajax({
                        url: $(this).attr("action"),
                        type: "POST",
                        data: $(this).serialize(),
                        success: function(response) {
                            alert("성공적으로 수정되었습니다.");
                            $("#hw-editModal").hide();
                            location.reload();
                        },
                        error: function(xhr) {
                            let errors = xhr.responseJSON;

                            // 각 필드별 에러 메시지 출력
                            if (errors.hwTitle) {
                                $("#editTitleError").text(errors.hwTitle);
                            }
                            if (errors.hwContent) {
                                $("#editContentError").text(errors.hwContent);
                            }
                            if (errors.hwProgress) {
                                $("#editProgressError").text(errors.hwProgress);
                            }
                            if (errors.hwDueDate) {
                                $("#editDueDateError").text(errors.hwDueDate);
                            }
                            if (errors.hwMemo) {
                                $("#editMemoError").text(errors.hwMemo);
                            }
                        }
                    });
                });



            </script>

        </div><!--콘텐츠영역끝-->
    </div><!--row-->
</div><!--container-->
</html>