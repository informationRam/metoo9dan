<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content" class="sb-nav-fixed">
    <link rel="stylesheet" href="/css/game/page2.css"/>
    <!--<div th:replace="~{각페이지에맞는사이드바파일경로::sidebar}"></div>-->
    <div id="layoutSidenav">
        <div th:replace="~{/game/gameSidebar::sidebar}"></div>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js"></script>
        <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

        <div id="layoutSidenav_content">
            <main>
                <div class="container-fluid">
                    <h1 class="mt-4">게임콘텐츠 등록</h1>
                    <ol class="breadcrumb mb-4">
                        <li class="breadcrumb-item">운영마당</li>
                        <li class="breadcrumb-item active">게임콘텐츠 작성</li>
                        <li class="breadcrumb-item active">
                            <span class="fw-bold text-danger">교육자료</span>
                        </li>
                        <li class="breadcrumb-item active">저장</li>
                    </ol>
                    <div style="border: 1px solid black;" class="col-10"> <!--class에서 col-10은 빼면 안됨-->
                        <form id="gameadd" class="my-3" th:action="@{/game/page2}" method="post" style="margin-left: 30px" enctype="multipart/form-data">
                            <!--------->
                            <div class="nado-education" id="nado-education">
                                    <h5 class="modal-title" id="educationModalLabel">교육자료목록</h5>
                                <div class="nado-education" id="nado-education">
                                    <!-- 검색 상자 추가 -->
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" placeholder="교육자료명 검색" id="searchInput">
                                        <button class="btn btn-outline-secondary" type="button" id="searchButton">검색</button>
                                    </div>
                                    <div class="table-wrapper">
                                        <table class="table table-bordered">
                                            <thead>
                                            <tr>
                                                <th>선택</th>
                                                <th scope="col">교육자료명</th>
                                                <th scope="col">자료구분</th>
                                                <th scope="col">자료유형</th>
                                                <th scope="col">서비스구분</th>
                                                <th scope="col">패키지상태</th>
                                                <th scope="col" colspan="2">등록일</th>
                                            </tr>
                                            </thead>
                                            <tbody class="table-light" id="educationlist">
                                            <tr th:each="education : ${allEducation}">
                                                <!-- 선택하기 -->
                                                <td class="custom-checkbox-label">
                                                    <input type="checkbox" class="form-check-input" name="selectedValues" th:value="${education.resourceNo}">
                                                    <span class="custom-checkbox-indicator"></span>
                                                    <!-- 교육자료 제목 -->
                                                <td class="education title" th:text="${education.resourceName}"></td>
                                                <!-- 자료구분 -->
                                                <td class="education resourceCate">
                                                        <span th:switch="${education.resourceCate}">
                                                            <span th:case="tutorial">튜토리얼</span>
                                                            <span th:case="lecture">교육영상</span>
                                                        </span>
                                                </td>
                                                <!-- 자료유형 -->
                                                <td class="education fileType">
                                                       <span th:switch="${education.fileType}">
                                                            <span th:case="'image'">이미지</span>
                                                            <span th:case="'video'">동영상</span>
                                                            <span th:case="'image/video'">이미지/동영상</span>
                                                            <span th:case="'ect'">기타</span>
                                                        </span>
                                                </td>
                                                <!-- 서비스구분 -->
                                                <td class="education serviceType">
                                                         <span th:switch="${education.serviceType}">
                                                            <span th:case="full">유료</span>
                                                            <span th:case=="short">무료</span>
                                                        </span>
                                                </td>
                                                <!-- 패키지유형 -->
                                                <td class="education-gameContents" th:text="${education.gameContents != null ? education.gameContents.gameName : '-'}" data-game-contents="${education.gameContents != null ? education.gameContents.gameName : '-'}"></td>
                                                <!-- 등록일 (수정하면 날짜 변경) -->
                                                <td class="education date">
                                                    <span th:text="${#temporals.format(education.creationDate,'yyyy-MM-dd HH:mm')}"></span>
                                                </td>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mb-3 text-center">
                                        <button type="button" class="btn btn-primary" onclick="submitSelected()">선택하기</button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="hiddenselectedValues" name="hiddenselectedValues" value="">


                            <button class="btn btn-primary btn-through">
                                다음
                            </button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script th:inline="javascript">
     // 선택한 교육 자료 번호를 저장할 배열
     var selectedResourceNos = [];

     // 체크박스 변경 이벤트에 대한 핸들러를 등록
     document.querySelectorAll('.form-check-input').forEach(function (checkbox) {
         checkbox.addEventListener('change', function () {
             var resourceNo = this.value;

                console.log("resourceNo",resourceNo)
             if (this.checked) {
                 // 체크된 경우 배열에 추가
                 selectedResourceNos.push(resourceNo);
             } else {
                 // 체크가 해제된 경우 배열에서 제거
                 var index = selectedResourceNos.indexOf(resourceNo);
                 if (index !== -1) {
                     selectedResourceNos.splice(index, 1);
                 }
             }

             // 선택한 자료 번호 배열을 문자열로 변환하여 숨겨진 필드에 할당
             var selectedValuesInput = document.getElementById('hiddenselectedValues');

             selectedValuesInput.value = selectedResourceNos.join(',');
             console.log("selectedValuesInput.value?:",selectedValuesInput.value)
         });
     });

 function clearSelectedValues() {
    selectedResourceNos = [];
    var selectedValuesInput = document.getElementById('hiddenselectedValues');
    selectedValuesInput.value = '';
}


 function submitSelected() {
    var selectedValuesInput = document.getElementById('hiddenselectedValues');
    var selectedResourceNos = selectedValuesInput.value;

    if (!selectedResourceNos || selectedResourceNos === '') {
            alert('선택 항목이 없습니다.');
            return;
        }
    var xhr = new XMLHttpRequest();

    xhr.open('POST', '/game/selectEdu', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

    var params = 'selectedValues=' + selectedResourceNos;

    xhr.onload = function () {
        if (this.status == 200) {
            var responseJson = JSON.parse(this.responseText);



            // JSON 응답 파싱
            var responseJson = JSON.parse(this.responseText);
            console.log("responseJson? : ", responseJson);

            // 메시지를 응답에서 가져와서 알림 창에 표시
            if (responseJson.message) {
                responseJson.textContent = responseJson.message;
                alert(responseJson.message);
            } else {
                responseJson.textContent = '서버 응답에 메시지가 없습니다.';
            }
        } else {
             responseJson.textContent = '서버에 오류가 발생했습니다.';
        }
    };

    xhr.send(params);

    // 선택한 자료 번호 배열 초기화
    clearSelectedValues();
}

    </script>
</div>
</html>
